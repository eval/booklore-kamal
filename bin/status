#!/usr/bin/env bash
set -e

cd "$(dirname "$0")/.."

echo "=== Deployed Version ==="
deployed=$(mise exec -- bin/kamal app exec --reuse 'sh -c "echo \$BOOKLORE_VERSION"' 2>&1 | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -1)
echo "Currently running: ${deployed:-unknown}"
echo

echo "=== Latest Releases ==="
gh release list --repo booklore-app/booklore --limit 5
echo

latest=$(gh release list --repo booklore-app/booklore --limit 1 --json tagName -q '.[0].tagName')
echo "=== Status ==="
if [ "$deployed" = "$latest" ]; then
  echo "✓ Up to date"
else
  echo "⚠ Update available: $deployed → $latest"
  echo
  echo "View changes: https://github.com/booklore-app/booklore/compare/$deployed...$latest"
  echo
  echo "To upgrade: ./bin/deploy"
fi
